name: Playground üêö
run-name: "Playground Workflow Run üêö"

on:
#  pull_request:
#    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Deployment/Environment"
        required: true
        type: environment
        default: "Minlopro DevHub"

permissions:
  contents: read
  id-token: write
  issues: read
  checks: write
  pull-requests: write

env:
  SF_CLI_VERSION: "2.77.6"

jobs:
  playground-run:
    timeout-minutes: 10
    environment: ${{ inputs.environment && inputs.environment ||  'Minlopro DevHub' }}
    env:
      SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
      SF_CLI_VERSION: ${{ vars.SF_CLI_VERSION }}
      GHA_WORKFLOW_RUN_LINK: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: "Build Environment üöú"
        uses: ./.github/actions/build-env
        env:
          SF_CLI_VERSION: ${{ vars.SF_CLI_VERSION }}
      - name: "Install Jest & Invoke"
        shell: bash
        run: |
          npm run jest -- --coverage
          tree coverage -L 2
          tree test-results -L 2
      - name: 'Generate Jest Tests Report'
        uses: dorny/test-reporter@v2
        with:
          name: LWC Jest Tests
          path: test-results/jest-*.xml
          reporter: jest-junit
          report-title: 'LWC Jest Tests'
          badge-title: 'lwc-jest-tests'
          list-suites: 'all'
          list-tests: 'failed'
          fail-on-error: 'true'
          fail-on-empty: 'true'
      - name: "Auth Salesforce Org üé´"
        id: auth-salesforce-org
        uses: ./.github/actions/auth-salesforce-org
        with:
          sfdx-auth-url: ${{ env.SF_AUTH_URL }}
      - name: "Run Apex Tests üöá"
        uses: ./.github/actions/run-apex-tests
        with:
          target-org-alias: "${{ steps.auth-salesforce-org.outputs.target-org-alias }}"
          class-names: "FeatureToggleTest:MockedCalloutsFactoryTest:StaticResourceDataLoadTest"
      - name: 'Bash Playground'
        shell: bash
        run: |
          echo "Actor: ${{ github.actor }}"
          exit 0
      - name: "Convert To Metadata API Format For Code Analyzer"
        run: |
          sf project convert source \
            --root-dir "src" \
            --output-dir "mdapi/src" \
            --metadata ApexClass \
            --metadata Flow \
            --metadata AuraDefinitionBundle \
            --metadata LightningComponentBundle
      - name: 'Run Salesforce Code Analyzer'
        id: run-code-analyzer
        uses: forcedotcom/run-code-analyzer@v2
        with:
          run-arguments: -w 'mdapi/src' -f 'results.csv' -f 'results.html' -f 'results.json' -r all -s 2
          results-artifact-name: salesforce-code-analyzer-results
