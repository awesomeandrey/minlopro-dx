<apex:page title="Merged Files Result" readOnly="true" docType="html-5.0">
    <apex:slds />
    <!--
        Lightning message service doesnâ€™t work in Visualforce pages
        that are included in Lightning Experience via iframes, including <wave:dashboard>, <apex:iframe>,
        and the standard HTML <iframe> tag. Instead, add Visualforce pages through
        the Lightning App Builder or as a utility bar item.
        https://developer.salesforce.com/docs/atlas.en-us.pages.meta/pages/message_channel_considerations.htm
    -->
    <script>
        const allowedOrigins = (() => {
            const origins = [];
            // Try parsing document.referrer safely
            if (document.referrer) {
                try {
                    origins.push(new URL(document.referrer).origin); // e.g. "https://connect-innovation-7252-dev-ed.scratch.lightning.force.com"
                } catch (e) {
                    console.warn('Invalid referrer URL:', document.referrer, e);
                }
            }
            // Always include the current window origin
            try {
                origins.push(window.location.origin); // e.g. "https://connect-innovation-7252-dev-ed--c.scratch.vf.force.com"
            } catch (e) {
                console.warn('Unable to resolve window.location.origin:', e);
            }
            return origins;
        })();

        function render() {
            const titleElement = document.querySelector('#title');
            const iframeElement = document.querySelector('iframe');
            if (!!iframeElement.src) {
                iframeElement.classList.remove('slds-hide');
                titleElement.classList.add('slds-hide');
            } else {
                iframeElement.classList.add('slds-hide');
                titleElement.classList.remove('slds-hide');
            }
        }

        window.addEventListener('load', () => {
            render();
        });

        window.addEventListener('message', (event) => {
            const eventOrigin = event.origin;
            if (!allowedOrigins.includes(eventOrigin)) {
                console.error('PDF preview should be framed within Lightning context only!');
                return;
            }
            const { type, value: base64EncodedPdfContent } = event.data;
            const iframeElement = document.querySelector('iframe');
            if (type === 'base64' && !!base64EncodedPdfContent) {
                iframeElement.src = 'data:application/pdf;base64,' + base64EncodedPdfContent;
            } else {
                iframeElement.removeAttribute('src');
            }
            render();
        });
    </script>
    <p id="title" class="slds-box slds-m-around_large slds-p-around_large slds-align_absolute-center slds-text-title_caps">
        Merged PDF Result Will Appear Here
    </p>
    <iframe class="slds-hide" title="Merged PDF Result" width="100%" height="550px"></iframe>
</apex:page>
